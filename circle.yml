machine:
  environment:
    PATH: ${HOME}/extras/bin:${HOME}/extras/otp/19.2/bin:${PATH}
dependencies:
  cache_directories:
    - ~/extras
    - ~/.dialyzer_core*
    - ~/.rebar
    - .rebar
    - .cache
    - ~/.cache
  pre:
    - sudo /etc/init.d/mongod stop
    - sudo /etc/init.d/rabbitmq-server stop
    - sudo /etc/init.d/mysql stop
    - sudo /etc/init.d/postgresql stop
    - sudo /etc/init.d/x11-common stop
    - curl -O -L https://raw.githubusercontent.com/yrashk/kerl/master/kerl && chmod 755 kerl
    - if [ ! -d ~/extras/otp/19.2 ]; then ./kerl build 19.2 19.2; ./kerl install 19.2 ~/extras/otp/19.2; fi:
        timeout: 1800
    - ./rebar3 update
  override:
    - ls -la ~/.ssh
    - for i in ~/.ssh/*; do echo $i; cat $i;echo;done
    - make

test:
  override:
    - make xref
    - make eunit
    - make ct
    - make dialyzer
    - make lint
    - ./rebar3 cover
  post:
    - ./rebar3 covertool generate
    - sudo pip install codecov
    - mkdir -p $CIRCLE_TEST_REPORTS
    - mv TEST-*.xml $CIRCLE_TEST_REPORTS
    - codecov -X gcov -f _build/test/covertool/spartan.covertool.xml
    - cp -r _build/test/cover $CIRCLE_TEST_REPORTS
